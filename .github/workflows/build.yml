name: Build
on:
  push:
    branches: [ master ]
jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, ubuntu-24.04-arm]
    steps:
      - name: Build in Docker (glibc 2.31)
        env:
          SECRET: ${{ secrets.SECRET }}
        run: |
          # 1) Write the script that will run *inside* the container
          cat > docker_build.sh << 'EOF'
          #!/usr/bin/env bash
          set -ex

          echo "=== Inside container ==="
          uname -m || true
          ldd --version | head -n1 || true

          apt-get update
          apt-get install -y git build-essential make ca-certificates curl

          # Install Node.js 25 (multi-arch, works on arm64 + amd64)
          curl -fsSL https://deb.nodesource.com/setup_25.x | bash -
          apt-get install -y nodejs

          git clone --recursive https://github.com/GSKruschewsky/uWebSockets.js.git
          cd uWebSockets.js

          make
          ls dist

          cd tests
          npm install ws
          node smoke.js
          cd ..

          ls dist

          git fetch origin binaries:binaries
          git checkout binaries

          cp dist/*.node .
          cp dist/*.js .
          git rev-parse master > source_commit
          ls

          git checkout master docs/index.d.ts
          mv docs/index.d.ts .

          git config --global user.email "luhkynaat@gmail.com"
          git config --global user.name "GSKruschewsky"

          git status

          git commit -a -m "[GitHub Actions] Updated ${GITHUB_OS} binaries" || true
          git push --force "https://GSKruschewsky:${SECRET}@github.com/GSKruschewsky/uWebSockets.js" binaries
          EOF

          chmod +x docker_build.sh

          # 2) Run that script inside ubuntu:20.04
          docker run --rm \
            -e SECRET="$SECRET" \
            -e GITHUB_OS="${{ matrix.os }}" \
            -v "$PWD:/work" \
            -w /work \
            ubuntu:20.04 \
            /work/docker_build.sh
