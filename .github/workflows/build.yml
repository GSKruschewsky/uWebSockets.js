name: Build
on:
  push:
    branches: [ master ]
jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, ubuntu-24.04-arm]
    steps:
      - name: Build in Docker (glibc 2.31)
        env:
          SECRET: ${{ secrets.SECRET }}
        run: |
          # 1) Write the script that will run *inside* the container
          cat > docker_build.sh << 'EOF'
          #!/usr/bin/env bash
          set -ex

          echo "=== Inside container ==="
          uname -m || true
          ldd --version | head -n1 || true

          apt-get update
          apt-get install -y wget gnupg ca-certificates software-properties-common

          # LLVM repo for clang-18 on Ubuntu 20.04 (focal)
          echo "deb http://apt.llvm.org/focal/ llvm-toolchain-focal-18 main" > /etc/apt/sources.list.d/llvm.list
          wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | apt-key add -
          apt-get update
          
          # Toolchain + Node for smoke test
          apt-get install -y git build-essential make cmake curl clang-18 lld-18 llvm-18-dev libclang-18-dev zlib1g-dev

          # Newer GCC (GCC 11) for C++20 <source_location>
          add-apt-repository -y ppa:ubuntu-toolchain-r/test
          apt-get update
          apt-get install -y gcc-11 g++-11
          
          # Set globally so all nested build systems use the right compiler
          export CC=gcc-11
          export CXX=g++-11
          
          # Verify
          $CC --version
          $CXX --version

          # Install Node.js 25 (multi-arch, works on arm64 + amd64)
          curl -fsSL https://deb.nodesource.com/setup_25.x | bash -
          apt-get install -y nodejs

          git clone --recursive https://github.com/GSKruschewsky/uWebSockets.js.git
          cd uWebSockets.js

          make
          ls dist

          cd tests
          npm install ws
          node smoke.js
          cd ..

          ls dist

          git fetch origin binaries:binaries
          git checkout binaries

          # Remove old binaries for this arch before adding the new ones
          case "$GITHUB_OS" in
            ubuntu-24.04-arm)
              # ARM64 binaries
              git rm -f uws_linux_arm64_*.node 2>/dev/null || true
              ;;
            ubuntu-24.04)
              # x64 binaries
              git rm -f uws_linux_x64_*.node 2>/dev/null || true
              ;;
          esac

          # Copy newly built binaries & JS wrapper from dist
          cp dist/*.node .
          cp dist/*.js .

          # Store the source commit from master
          git rev-parse master > source_commit
          ls

          # Get index.d.ts from master and write it as a top-level file
          git show master:docs/index.d.ts > index.d.ts

          # Stage new binaries + index.d.ts + source_commit
          git add uws*.node uws.js index.d.ts source_commit

          git config --global user.email "luhkynaat@gmail.com"
          git config --global user.name "GSKruschewsky"

          git status

          git commit -m "[GitHub Actions] Updated ${GITHUB_OS} binaries" || true
          git push --force "https://GSKruschewsky:${SECRET}@github.com/GSKruschewsky/uWebSockets.js" binaries
          EOF

          chmod +x docker_build.sh

          # 2) Run that script inside ubuntu:20.04
          docker run --rm \
            -e SECRET="$SECRET" \
            -e GITHUB_OS="${{ matrix.os }}" \
            -v "$PWD:/work" \
            -w /work \
            ubuntu:20.04 \
            /work/docker_build.sh
